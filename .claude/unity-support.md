# Unity Project Support

This document explains how the extension supports Unity C# projects.

## The Problem

Unity projects have a unique challenge compared to standard .NET projects:

1. **Unity manages `.csproj` files automatically**
   - Unity regenerates `.csproj` and `.sln` files whenever the project structure changes
   - These files are transient and not meant to be edited manually

2. **Unity doesn't use NuGet's PackageReference system**
   - No `*.csproj.nuget.g.props` files are generated in the `obj/` directory
   - Unity strips out NuGet metadata when regenerating project files

3. **Language server can provide inaccurate diagnostics**
   - The C# language server (OmniSharp/Roslyn/Dev Kit) loads Unity `.csproj` files
   - **BUT** if Unity hasn't compiled the project yet, the language server lacks full metadata
   - This causes the language server to incorrectly mark required usings as "unused"
   - If we blindly remove these "unused" usings, we break the code

## The Solution

### Project Type Detection

The extension detects Unity projects by looking for Unity-specific folder structure:
- `Assets/` folder - contains all game scripts and resources
- `ProjectSettings/` folder - contains Unity project settings
- These folders indicate a Unity project root

**Implementation:** [`isUnityProject()` in utils.ts](../src/utils.ts)

### Unity Project Compilation Check

For Unity projects, the extension checks if Unity has compiled the project by looking for:
- `Library/ScriptAssemblies/{ProjectName}.dll`

**How it works:**
1. Find the Unity project root (where `Assets/` and `Library/` folders exist)
2. Check for the compiled assembly DLL in `Library/ScriptAssemblies/`
3. The DLL name matches the `.csproj` file name (e.g., `Assembly-CSharp.dll`)

**Why this works:**
- Unity's build system compiles C# scripts into DLLs stored in `Library/ScriptAssemblies/`
- If the DLL exists, Unity has successfully compiled the project
- This means the language server has access to accurate metadata about what's actually used

**Implementation:** [`isUnityProjectCompiled()` in utils.ts](../src/utils.ts)

### Standard .NET Project Check

For non-Unity projects, the extension uses the original check:
- Looks for `*.csproj.nuget.g.props` in the `obj/` directory
- This file is created during `dotnet restore` or build
- Indicates NuGet packages have been restored and the project is ready

**Implementation:** [`isProjectRestored()` in utils.ts](../src/utils.ts)

## User-Facing Error Messages

The extension provides different error messages based on project type:

### Unity Project Error
```
No action was taken because the project, Assembly-CSharp.csproj,
has not been compiled by Unity. Please open the project in Unity
and let it compile, then try again.
```

### Standard .NET Project Error
```
No action was taken because the project, MyProject.csproj,
has not been restored. Please run "dotnet restore" or build
the project and try again.
```

**Implementation:** [`ProjectValidator.ts`](../src/services/ProjectValidator.ts)

## Unity Project Structure

For reference, here's what a Unity project looks like:

```
MyUnityProject/
├── Assets/                      # Game scripts, assets, resources
│   ├── Scripts/
│   │   └── PlayerController.cs
│   └── ...
├── Library/                     # Unity's build output (gitignored)
│   ├── ScriptAssemblies/        # Compiled C# DLLs
│   │   ├── Assembly-CSharp.dll  # Main project assembly
│   │   ├── Assembly-CSharp.pdb
│   │   └── ...
│   └── Bee/                     # Unity's Bee build system artifacts
├── ProjectSettings/             # Unity settings (version controlled)
├── Packages/                    # Unity Package Manager
│   └── manifest.json
├── Assembly-CSharp.csproj       # Generated by Unity
├── MyUnityProject.sln           # Generated by Unity
└── ...
```

**Key folders:**
- `Assets/` and `ProjectSettings/` - Version controlled
- `Library/` - Build artifacts (gitignored)
- `.csproj` and `.sln` files - Regenerated by Unity (gitignored)

## Language Server Compatibility

This solution works with all three C# language server options in VS Code:

1. **OmniSharp** (legacy, still widely used)
   - Diagnostics: `{ code: 'CS8019', source: 'csharp' }`

2. **Roslyn** (newer LSP-based server)
   - Diagnostics: `{ code: { value: 'IDE0005' }, source: 'roslyn' }`

3. **C# Dev Kit** (Microsoft's official extension)
   - Uses Roslyn under the hood
   - Same diagnostic format as Roslyn

The extension handles all three formats when detecting unused usings.

## Why This Approach is Necessary

**Without the Unity compilation check:**
1. User opens Unity project in VS Code
2. Language server loads but doesn't have full metadata (Unity hasn't compiled)
3. Language server incorrectly reports usings as "unused" (CS8019/IDE0005)
4. Extension removes those usings
5. Code breaks! The usings were actually required

**With the Unity compilation check:**
1. User opens Unity project in VS Code
2. Extension checks if `Library/ScriptAssemblies/{Project}.dll` exists
3. If not found → Shows error: "Please compile in Unity first"
4. User opens project in Unity, lets it compile
5. DLL is created with full metadata
6. Language server now has accurate information
7. Extension safely removes only truly unused usings

## Testing Recommendations

To test Unity support:

1. **Create a test Unity project**
   ```bash
   # In Unity Hub, create new project
   # Let Unity open and compile it
   ```

2. **Verify initial state**
   ```bash
   # Should exist after Unity compiles:
   ls Library/ScriptAssemblies/Assembly-CSharp.dll
   ```

3. **Test before compilation**
   - Delete `Library/` folder
   - Open `.cs` file in VS Code
   - Try to organize usings
   - Should see Unity-specific error message

4. **Test after compilation**
   - Open project in Unity (regenerates Library/)
   - Open `.cs` file in VS Code
   - Organize usings should work correctly

## Related Issues

- [Issue #27](https://github.com/JeremyCaron/vscode-csharp-organize-usings/issues/27) - Unity project support

## References

- [Unity Script Compilation](https://docs.unity3d.com/Manual/ScriptCompilationAssemblyDefinitionFiles.html)
- [Unity Project Folder Structure](https://v.zasadnyy.com/blog/mastering-unity-project-folder-structure-level-0-vcs/)
- [Unity and NuGet Incompatibility](https://discussions.unity.com/t/unity-strips-out-nuget-properties-on-csproj-files/665982)
